workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "api"

default:
  tags:
    - saas-linux-small-amd64
  image: skosukhin/lumi-ci-test

variables:
  SCHEDULER_PARAMETERS: >-
    --account=project_465000454
    --nodes=1
    --ntasks=1
    --cpus-per-task=4
    --mem-per-cpu=1G
    --time=05:00
    ${EXTRA_SCHEDULER_PARAMETERS}
  EXTRA_SCHEDULER_PARAMETERS:

.gpu:
  variables:
    EXTRA_SCHEDULER_PARAMETERS: >-
      --partition=dev-g
      --gpus=1

.cpu:
  variables:
    EXTRA_SCHEDULER_PARAMETERS: >-
      --partition=debug

.cce:
  variables:
    # Core variables:
    FC: gfortran
    # Convenience variables:
    VERSION_FCFLAGS: --version
    COMPILER_MODULES: PrgEnv-cray cce/16.0.1 craype-x86-milan

.dp:
  variables:
    FPMODEL: DP
    FAILURE_THRESHOLD: "5.8e-2"

.sp:
  variables:
    FPMODEL: SP
    FAILURE_THRESHOLD: "3.5e-1"

#
# Set up Python virtual environment
#
.python-common:
  variables:
    PYHOME: ${CI_PROJECT_DIR}/python-venv
    FF_USE_FASTZIP: 1
  cache:
    # Update the key to regenerate the virtual environment:
    key: python-venv-version-1
    paths:
      - ${PYHOME}
    policy: pull

setup-python:
  extends:
    - .cpu
    - .python-common
  variables:
    GIT_STRATEGY: none
  script:
    - test ! -d "${PYHOME}" || exit 0
    - python -m venv ${PYHOME}
    - ${PYHOME}/bin/python -m pip install --upgrade pip
    - ${PYHOME}/bin/python -m pip install dask[array] netCDF4 numpy xarray
  cache:
    policy: pull-push

.common:
  extends: .python-common
  needs:
    - setup-python
  variables:
    PYHOME: ${CI_PROJECT_DIR}/python-venv
    # Make variables:
    FCINCLUDE: -I/usr/include
    RRTMGP_ROOT: ${CI_PROJECT_DIR}
    RRTMGP_DATA: ${CI_PROJECT_DIR}/rrtmgp-data
  before_script:
    # Extend the existing environment variables:
    - export PATH="${PYHOME}/bin:${PATH}"
  script:
    #
    # Build libraries, examples and tests
    #
    - ${FC} ${VERSION_FCFLAGS}
    - make libs
    - make -C build separate-libs
    #
    # Check out data
    #
    - git clone --depth 1 https://github.com/earth-system-radiation/rrtmgp-data.git "${RRTMGP_DATA}"
    #
    # Run examples and tests
    #
    - make tests
    #
    # Compare the results
    #
    - make check

.cce-gpu-openacc:
  extends:
    - .gpu
    - .cce
    - .common
  variables:
    # Compiler flags used for ICON model:
    FCFLAGS: -ffree-line-length-none -m64 -std=f2008 -march=native -fbounds-check -fmodule-private -fimplicit-none -finit-real=nan -g -DRTE_USE_CBOOL -DRTE_USE_${FPMODEL}
    RTE_KERNELS: default
    # Convenience variables:
    EXTRA_COMPILER_MODULES: craype-accel-amd-gfx90a rocm

cce-gpu-openacc-DP:
  extends:
    - .dp
    - .cce-gpu-openacc

cce-gpu-openacc-SP:
  extends:
    - .dp
    - .cce-gpu-openacc
